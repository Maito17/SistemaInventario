{% load static %}

<!DOCTYPE html>
<html lang="es">

<head>
  {% block extra_head %} {% endblock extra_head %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Sistema de Ventas | Dashboard{% endblock %}</title>

  <link rel="icon" href="{% static 'favicon.ico' %}">

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" />
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}" />
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}" />
  <link rel="stylesheet" href="{% static 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}" />
</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">
    <div class="preloader flex-column justify-content-center align-items-center">
      <img class="animation__shake" src="{% static 'dist/img/AdminLTELogo.png' %}" alt="AdminLTELogo" height="60"
        width="60" />
    </div>

    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="{% url 'dashboard' %}" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <!-- Enlace a Planes eliminado -->
        </li>
      </ul>

      <ul class="navbar-nav ml-auto">
        <!-- Notificaciones de Caducidad -->
        <li class="nav-item dropdown" id="caducidad-notifications">
          <a class="nav-link" data-toggle="dropdown" href="#">
            <i class="fas fa-calendar-times"></i>
            <span class="badge badge-warning navbar-badge" id="caducidad-count" style="display: none;"></span>
          </a>
          <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" style="min-width: 350px;">
            <span class="dropdown-header" id="caducidad-header"><i class="fas fa-calendar-times"></i> Productos Próximos
              a Vencer</span>
            <div class="dropdown-divider"></div>
            <div id="caducidad-list" style="max-height: 400px; overflow-y: auto;">
              <div class="dropdown-item text-muted text-center p-3">
                <small>Cargando alertas...</small>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="{% url 'inventario:lista' %}" class="dropdown-item dropdown-footer text-center py-2">
              <i class="fas fa-list"></i> Ver Inventario
            </a>
          </div>
        </li>

        <!-- Notificaciones de Alertas (Compras Pendientes + Productos Bajo Stock) -->
        <li class="nav-item dropdown" id="compras-pendientes-notifications">
          <a class="nav-link" data-toggle="dropdown" href="#">
            <i class="fas fa-bell"></i>
            <span class="badge badge-danger navbar-badge" id="compras-pendientes-count" style="display: none;"></span>
          </a>
          <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" style="min-width: 350px;">
            <span class="dropdown-header" id="compras-pendientes-header"><i class="fas fa-bell"></i> Alertas del
              Sistema</span>
            <div class="dropdown-divider"></div>
            <div id="compras-pendientes-list" style="max-height: 400px; overflow-y: auto;">
              <div class="dropdown-item text-muted text-center p-3">
                <small>Cargando alertas...</small>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="{% url 'inventario:lista_compras' %}" class="dropdown-item dropdown-footer text-center py-2">
              <i class="fas fa-shopping-cart"></i> Ver Todas las Compras
            </a>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>

        <li class="nav-item">
          <form method="POST" action="{% url 'usuarios:logout' %}" style="display: inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-link nav-link" style="
                  padding: 0;
                  border: none;
                  background: none;
                  cursor: pointer;
                  color: #6c757d;
                ">
              <i class="fas fa-sign-out-alt"></i> Salir
            </button>
          </form>
        </li>
      </ul>
    </nav>
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <a href="{% url 'dashboard' %}" class="brand-link">
        <img src="{% static 'dist/img/AdminLTELogo.png' %}" alt="Logo" class="brand-image img-circle elevation-3"
          style="opacity: 0.8" />
        <span class="brand-text font-weight-light">Sistema Ventas</span>
      </a>

      <div class="sidebar">
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          {% if user.is_authenticated %}
          <div class="image">
            <img src="{% static 'dist/img/user-profile.png' %}" class="img-circle elevation-2" alt="User Image"
              style="width: 40px; height: 40px; border: 3px solid #fff;" />
          </div>
          <div class="info">
            <a href="#" class="d-block">{{ user.username }}</a>
          </div>
          {% else %}
          <div class="info">
            <a href="{% url 'usuarios:login' %}" class="d-block">Invitado</a>
          </div>
          {% endif %}
        </div>

        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <li class="nav-item">
              <a href="{% url 'dashboard' %}"
                class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <i class="nav-icon fas fa-tachometer-alt"></i>
                <p>Dashboard</p>
              </a>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-shopping-cart"></i>
                <p>
                  Ventas
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'ventas:nueva_venta' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Nueva Venta</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'pos:historial_ventas' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Historial de Ventas</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'ventas:lista_detalles_venta' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Detalles de Ventas</p>
                  </a>
                </li>
                <!-- RUTA DE APERTURA DE CAJA -->
                <li class="nav-item">
                  <a href="{% url 'ventas:apertura_caja' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Apertura de Caja/ Cierre</p>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-box"></i>
                <p>
                  Inventario
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'inventario:lista' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Lista de Productos</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'inventario:proveedores_lista' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Proveedores</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'inventario:categorias_lista' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Categorías</p>
                  </a>
                </li>
                <li class="nav-divider"></li>
                <li class="nav-item">
                  <a href="{% url 'inventario:lista_compras' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Compras</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'inventario:lista_detalles_compra' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Detalles de Compra</p>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-users"></i>
                <p>
                  Clientes
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'clientes:lista' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Lista de Clientes</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'clientes:crear' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Agregar Nuevo Cliente</p>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-wallet"></i>
                <p>
                  Finanzas
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'finanzas:lista_amortizaciones_proveedor' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Amortizaciones a Proveedores</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'finanzas:lista_amortizaciones_cliente' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Amortizaciones a Clientes</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'finanzas:lista_cuentas_por_pagar' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Cuentas por Pagar</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'finanzas:lista_cuentas_por_cobrar' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Cobros a Clientes</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'finanzas:lista_solicitudes_credito' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Solicitudes de Crédito</p>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-money-bill-wave"></i>
                <p>
                  Gastos
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'gasto:lista_gastos' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Listar Gastos</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'gasto:crear_gasto' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Nuevo Gasto</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'gasto:lista_detalles_admin' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Detalles Gastos Admin</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'gasto:lista_detalles_venta' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Detalles Gastos Venta</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'gasto:lista_tipos' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Tipos de Gasto</p>
                  </a>
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-chart-bar"></i>
                <p>
                  Reportes
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'ventas:reportes_ventas_periodo' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Ventas por Período</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'ventas:ranking_productos' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Productos Más Vendidos</p>
                  </a>
                </li>
              </ul>
            </li>


            
            {% if request.user.is_superuser or request.user.is_staff %}
            <li class="nav-header">ADMINISTRACIÓN</li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-cog"></i>
                <p>
                  Configuración
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="{% url 'configuracion_empresa' %}" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Configuración de Empresa</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="#" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>
                      Personal
                      <i class="fas fa-angle-left right"></i>
                    </p>
                  </a>
            {% endif %}
                  <ul class="nav nav-treeview">
                    <li class="nav-item">
                      <a href="{% url 'usuarios:lista_personal' %}" class="nav-link">
                        <i class="far fa-dot-circle nav-icon"></i>
                        <p>Estado de Personal</p>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a href="{% url 'usuarios:lista_usuarios' %}" class="nav-link">
                        <i class="far fa-dot-circle nav-icon"></i>
                        <p>Trabajadores</p>
                      </a>
                    </li>
                  </ul>
                </li>
                {% if request.user.is_superuser or request.user.is_staff %}
                <li class="nav-item">
                  <a href="{% url 'usuarios:lista_roles' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'lista_roles' %}active{% endif %}">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Roles y Permisos</p>
                  </a>
                </li>
                {% endif %}
              </ul>
            </li>
            

          </ul>
        </nav>
      </div>
    </aside>

    <div class="content-wrapper">
      {% block content_header %}
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Dashboard</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item">
                  <a href="{% url 'dashboard' %}">Home</a>
                </li>
                <li class="breadcrumb-item active">Dashboard</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      {% endblock content_header %}

      <section class="content">
        <div class="container-fluid">
          {% block content %} {% endblock content %}
        </div>
      </section>
    </div>
    <footer class="main-footer">
      <strong>Copyright &copy; 2024 <a href="#">Sistema de Ventas</a>.</strong>
      Todos los derechos reservados.
      <div class="float-right d-none d-sm-inline-block">
        <b>Versión</b> 1.0.0
      </div>
    </footer>

    <aside class="control-sidebar control-sidebar-dark"></aside>
  </div>
  <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
  <script>
    $.widget.bridge("uibutton", $.ui.button);
  </script>
  <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
  <script src="{% static 'dist/js/adminlte.js' %}"></script>

  {% block extra_js %}
  <script>
    console.log("=== SISTEMA DE ALERTAS INICIANDO ===");

    // ===== FUNCIÓN PARA ALERTAS DE CADUCIDAD =====
    function updateCaducidadAlerts() {
      $.ajax({
        url: "{% url 'inventario:alertas_caducidad_ajax' %}",
        type: 'GET',
        dataType: 'json',
        success: function (data) {
          const count = data.count;
          const $countSpan = $('#caducidad-count');
          const $header = $('#caducidad-header');
          const $list = $('#caducidad-list');

          // 1. Actualizar el Contador
          if (count > 0) {
            $countSpan.text(count).show();
            $header.html(`<i class="fas fa-exclamation-circle text-danger"></i> ${count} Productos Próximos a Vencer`);
          } else {
            $countSpan.hide();
            $header.html('<i class="fas fa-check-circle text-success"></i> Todo en Orden');
          }

          // 2. Llenar la lista desplegable
          $list.empty();
          if (count > 0) {
            data.alertas.forEach(function (alerta, index) {
              let icono = 'fa-exclamation-triangle';
              let borderClass = 'border-warning';
              let bgColor = 'bg-light';

              if (alerta.dias_restantes < 0) {
                icono = 'fa-times-circle';
                borderClass = 'border-danger';
              } else if (alerta.dias_restantes <= 7) {
                icono = 'fa-bell';
                borderClass = 'border-danger';
              } else {
                icono = 'fa-info-circle';
                borderClass = 'border-warning';
              }

              let mensaje = '';
              let colorTexto = 'text-warning';

              if (alerta.dias_restantes < 0) {
                mensaje = `<span class="badge badge-danger">VENCIDO</span> Hace ${Math.abs(alerta.dias_restantes)} días`;
                colorTexto = 'text-danger';
              } else if (alerta.dias_restantes === 0) {
                mensaje = `<span class="badge badge-danger">HOY</span> Caduca hoy`;
                colorTexto = 'text-danger';
              } else if (alerta.dias_restantes <= 7) {
                mensaje = `<span class="badge badge-danger">${alerta.dias_restantes}d</span> Caduca en ${alerta.dias_restantes} días`;
                colorTexto = 'text-danger';
              } else {
                mensaje = `<span class="badge badge-warning">${alerta.dias_restantes}d</span> Caduca en ${alerta.dias_restantes} días`;
                colorTexto = 'text-warning';
              }

              const item = `
                                <div class="dropdown-item p-3 ${borderClass}" style="border-left: 4px solid; margin-bottom: 5px; background: #f8f9fa;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div style="flex: 1;">
                                            <h6 class="mb-1" style="font-weight: 600; color: #333;">
                                                <i class="fas ${icono} ${colorTexto}"></i> ${alerta.nombre}
                                            </h6>
                                            <p class="mb-1" style="font-size: 0.85rem; color: #666;">
                                                Stock: <strong>${alerta.cantidad} unidades</strong>
                                            </p>
                                            <p class="mb-0" style="font-size: 0.80rem; color: #999;">
                                                Vence: ${alerta.fecha_caducidad}
                                            </p>
                                        </div>
                                        <div class="text-right ${colorTexto}" style="white-space: nowrap; margin-left: 10px;">
                                            ${mensaje}
                                        </div>
                                    </div>
                                </div>
                            `;
              $list.append(item);
            });
          } else {
            $list.html(`
                            <div class="text-center p-4">
                                <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #28a745; margin-bottom: 10px;"></i>
                                <p class="text-success"><strong>¡Todo en orden!</strong></p>
                                <small class="text-muted">No hay productos próximos a vencer</small>
                            </div>
                        `);
          }
        },
        error: function () {
          console.error("No se pudieron cargar las alertas de caducidad.");
          $('#caducidad-count').text('!').show();
          $('#caducidad-list').html(`
                        <div class="text-center p-4">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #dc3545;"></i>
                            <p class="text-danger text-sm">Error al cargar alertas</p>
                        </div>
                    `);
        }
      });
    }

    // Cargar alertas de caducidad al inicio
    updateCaducidadAlerts();

    // Recargar las alertas cada 60 segundos
    setInterval(updateCaducidadAlerts, 60000);

    // ===== FUNCIÓN PARA ALERTAS DE COMPRAS PENDIENTES Y BAJO STOCK =====
    function updateComprasPendientesAlerts() {
      console.log("Cargando alertas...");

      // Cargar datos de ambas fuentes en paralelo
      Promise.all([
        fetch("{% url 'inventario:alertas_compras_ajax' %}", {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(r => r.json()),
        fetch("{% url 'inventario:alertas_bajo_stock_ajax' %}", {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(r => r.json())
      ]).then(([dataCompras, dataBajoStock]) => {
        console.log("Datos recibidos:", { compras: dataCompras, stock: dataBajoStock });
        console.log("Count compras:", dataCompras.count, "Count stock:", dataBajoStock.count);
        console.log("Alertas compras:", dataCompras.alertas);
        console.log("Productos bajo stock:", dataBajoStock.productos);

        const countCompras = dataCompras.count || 0;
        const countBajoStock = dataBajoStock.count || 0;
        const totalAlertas = countCompras + countBajoStock;

        const $countSpan = $('#compras-pendientes-count');
        const $header = $('#compras-pendientes-header');
        const $list = $('#compras-pendientes-list');

        // Actualizar el contador
        if (totalAlertas > 0) {
          $countSpan.text(totalAlertas).show();
          if (countCompras > 0 && countBajoStock > 0) {
            $header.html(`<i class="fas fa-exclamation-triangle text-danger"></i> ${countCompras} Compras + ${countBajoStock} Productos`);
          } else if (countCompras > 0) {
            $header.html(`<i class="fas fa-exclamation-triangle text-warning"></i> ${countCompras} Compras Pendientes`);
          } else {
            $header.html(`<i class="fas fa-exclamation-triangle text-danger"></i> ${countBajoStock} Productos Bajo Stock`);
          }
        } else {
          $countSpan.hide();
          $header.html('<i class="fas fa-check-circle text-success"></i> Todo en Orden');
        }

        // Llenar la lista
        $list.empty();

        // Agregar compras pendientes
        if (countCompras > 0) {
          $list.append(`<div class="p-2" style="background: #fff3cd; border-bottom: 1px solid #ffc107;">
                        <small style="font-weight: bold; color: #856404;">
                            <i class="fas fa-money-bill-alt"></i> COMPRAS PENDIENTES (${countCompras})
                        </small>
                    </div>`);

          dataCompras.alertas.forEach(function (alerta) {
            let icono = 'fa-calendar-alt';
            let colorTexto = 'text-warning';
            let mensaje = '';

            if (alerta.dias_restantes < 0) {
              icono = 'fa-exclamation-circle';
              colorTexto = 'text-danger';
              mensaje = `<span class="badge badge-danger">VENCIDO</span>`;
            } else if (alerta.dias_restantes === 0) {
              icono = 'fa-exclamation-triangle';
              colorTexto = 'text-danger';
              mensaje = `<span class="badge badge-danger">HOY</span>`;
            } else if (alerta.dias_restantes <= 7) {
              icono = 'fa-bell';
              colorTexto = 'text-danger';
              mensaje = `<span class="badge badge-danger">${alerta.dias_restantes}d</span>`;
            } else {
              icono = 'fa-calendar-check';
              colorTexto = 'text-warning';
              mensaje = `<span class="badge badge-warning">${alerta.dias_restantes}d</span>`;
            }

            const item = `
                            <a href="${alerta.url_editar}" class="dropdown-item p-2" style="border-left: 4px solid #ffc107; text-decoration: none; color: inherit; font-size: 0.9rem;">
                                <div>
                                    <h6 class="mb-0" style="font-weight: 600; color: #333; font-size: 0.9rem;">
                                        <i class="fas ${icono} ${colorTexto}"></i> ${alerta.numero}
                                    </h6>
                                    <small style="color: #666;">${alerta.proveedor} ${mensaje}</small>
                                </div>
                            </a>
                        `;
            $list.append(item);
          });
        }

        // Agregar productos bajo stock
        if (countBajoStock > 0) {
          if (countCompras > 0) {
            $list.append('<div class="dropdown-divider"></div>');
          }

          $list.append(`<div class="p-2" style="background: #f8d7da; border-bottom: 1px solid #dc3545;">
                        <small style="font-weight: bold; color: #721c24;">
                            <i class="fas fa-boxes"></i> PRODUCTOS BAJO STOCK (${countBajoStock})
                        </small>
                    </div>`);

          dataBajoStock.productos.forEach(function (producto) {
            const item = `
                            <a href="{% url 'inventario:lista' %}" class="dropdown-item p-2" style="border-left: 4px solid #dc3545; text-decoration: none; color: inherit; font-size: 0.9rem;">
                                <div>
                                    <h6 class="mb-0" style="font-weight: 600; color: #333; font-size: 0.9rem;">
                                        <i class="fas fa-warning text-danger"></i> ${producto.nombre}
                                    </h6>
                                    <small style="color: #666;">SKU: ${producto.sku} - <span class="badge badge-danger">${producto.cantidad} unid.</span></small>
                                </div>
                            </a>
                        `;
            $list.append(item);
          });
        }

        // Si no hay alertas
        if (totalAlertas === 0) {
          $list.html(`
                        <div class="text-center p-4">
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #28a745; margin-bottom: 10px;"></i>
                            <p class="text-success mb-0"><strong>¡Sistema en Orden!</strong></p>
                        </div>
                    `);
        }
      }).catch(error => {
        console.error("Error al cargar alertas:", error);
        $('#compras-pendientes-count').text('!').show();
      });
    }

    // Cargar alertas al inicio
    console.log("Iniciando carga de alertas del sistema...");
    updateComprasPendientesAlerts();

    // Recargar las alertas cada 60 segundos
    setInterval(updateComprasPendientesAlerts, 60000);

  </script>
  {% endblock extra_js %}
  <script src="{% static 'dist/js/base.js' %}"></script>
</body>
<script src="{% static 'chatbot_ia.js' %}"></script>

</html>